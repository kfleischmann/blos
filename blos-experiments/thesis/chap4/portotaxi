#!/bin/bash

# this script produce the result of the real world dataset
DATA_DIR=~/tmp/blos/experiments/portotaxi/expt3/

# DEFAULT VALUES
SKETCH_HH=100
#SKETCH_SIZE_DELTA="0.5 0.1 0.05 0.01"
#SKETCH_SIZE_EPSILON="0.01 0.001 0.0001 0.000015 0.00001"

SKETCH_SIZE_DELTA="0.01"
 #0.01 0.1"
SKETCH_SIZE_EPSILON="0.000002"
 #0.00003 0.00005 0.00007"
DPI=100
FORMAT=png
WINDOW="0.005:0.005"
MIN_GPS="41.12,-8.66"
MAX_GPS="41.18,-8.59"
GPS_RESOLUTION=3
SHORT_TRIP_LENGTH=10 # minutes
RADIUS=200	# in meters
HOURS="0:24:1"
NUM=2

# cleanup
rm -r ${DATA_DIR}
mkdir -p ${DATA_DIR}/dataset
mkdir -p ${DATA_DIR}/sketch

IFS=', ' read -r -a LIST_SKETCH_SIZE_DELTA <<< "$SKETCH_SIZE_DELTA"
IFS=', ' read -r -a LIST_SKETCH_SIZE_EPSILON <<< "$SKETCH_SIZE_EPSILON"
for d in "${LIST_SKETCH_SIZE_DELTA[@]}"
do
	for e in "${LIST_SKETCH_SIZE_EPSILON[@]}"
	do
		SKETCH_SIZE="${d}:${e}"
		SKETCH_FILE=${d}_${e}

		rm -r ${DATA_DIR}/sketch/${SKETCH_FILE}
		mkdir -p ${DATA_DIR}/sketch/${SKETCH_FILE}

		for i in $(seq 2 $NUM); do
			SEED=$i
			echo "SEED=$i"

			RANDOM_GPS=$(blos experiments random-gps $MIN_GPS $MAX_GPS $SEED)
			RANDOM_GPS2=$(echo "$RANDOM_GPS" | tr ',' ':' )
			#RANDOM_GPS2="41.163723:-8.647637"

			OUTPUT_FILE=${DATA_DIR}/sketch/${SKETCH_FILE}/taxi_dataset_result_${SKETCH_FILE}_$(echo "$RANDOM_GPS2"|tr ':' '_')

			blos examples run eu.blos.scala.examples.portotaxi.PortoTaxi \
				--input /home/kay/Dropbox/kay-rep/Uni-Berlin/Masterarbeit/Sources/blos/datasets/portotaxi/taxi2.tsv \
				--output ${OUTPUT_FILE}.tsv \
				--sketch ${SKETCH_SIZE} \
				--center ${RANDOM_GPS2} \
				--window ${WINDOW} \
				--resolution ${GPS_RESOLUTION} \
				--shorttriplength ${SHORT_TRIP_LENGTH} \
				--radius ${RADIUS} \
				--hours ${HOURS}

			# compare sketch-based counts and real counts
			blos experiments portotaxi-hours-plot \
					${OUTPUT_FILE}.tsv:0:1:*:r:'-':'real_long_trips',${OUTPUT_FILE}.tsv:0:3:*:r:'--':'sketched_long_trips',${OUTPUT_FILE}.tsv:0:2:o:b:'-':'real_short_trips',${OUTPUT_FILE}.tsv:0:4:o:b:'--':'sketched_short_trips' \
					${OUTPUT_FILE}.${FORMAT}:${DPI}


		done
	done
done
