#!/bin/bash
# KMeans
# Experiement
#
# 3 centers
# input space per dimension: [-1...+1]
# resolution #.###

DATA_DIR=~/tmp/blos/experiments/kmeans

# cleanup
rm -r ${DATA_DIR}
mkdir -p ${DATA_DIR}/dataset
mkdir -p ${DATA_DIR}/result
mkdir -p ${DATA_DIR}/flink

NUM_SAMPLES=1000
NUM_CENTROIDS=3
RESOLUTION=3
ITERATIONS=10
RANGE=1.0
STDDEV=0.09
DPI=100
SEED=3

# prepare dataset

blos examples run eu.blos.java.ml.clustering.KMeansDatasetGenerator \
        -points ${NUM_SAMPLES} \
        -k ${NUM_CENTROIDS} \
        -stddev ${STDDEV} \
        -range ${RANGE} \
        -resolution ${RESOLUTION} \
	-output ${DATA_DIR}/dataset


blos visualize kmeans-plotter -i ${DATA_DIR}/dataset/points -o ${DATA_DIR}/dataset/kmeans-dataset-grid5.eps --dpi=${DPI} -s dataset --grid --gres=-1:1:0.5 --hideaxis

blos visualize kmeans-plotter -i ${DATA_DIR}/dataset/points -o ${DATA_DIR}/dataset/kmeans-dataset-grid2.eps --dpi=${DPI} -s dataset --grid --gres=-1:1:0.2 --hideaxis

blos visualize kmeans-plotter -i ${DATA_DIR}/dataset/points -o ${DATA_DIR}/dataset/kmeans-dataset-grid1.eps --dpi=${DPI} -s dataset --grid --gres=-1:1:0.1 --hideaxis

# produce good init
blos experiments kmeans-manipulate-centers \
	${DATA_DIR}/dataset/centers \
	0.2 \
	$SEED >> ${DATA_DIR}/dataset/init_good_centers

# random init
# generated by kmeans

blos visualize plotpoints points \
	${DATA_DIR}/dataset/points  \
	${DATA_DIR}/dataset/kmeans-dataset.eps:${DPI}

blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-grid.eps:${DPI} \
	grid


blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-init-random.eps:${DPI} \
        ${DATA_DIR}/dataset/init_centers

blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-init-good.eps:${DPI} \
        ${DATA_DIR}/dataset/init_good_centers


blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-init-real.eps:${DPI} \
        ${DATA_DIR}/dataset/centers


# use random centers
# generate results for standard kmeans for N iterations
ITERATIONS="0 1 2 3 10"

for i in $ITERATIONS; do
	echo "iteration $i"
	blos examples run eu.blos.java.ml.clustering.FlinkKMeans \
		${DATA_DIR}/dataset/points \
		${DATA_DIR}/dataset/init_centers \
		${DATA_DIR}/flink/random/n${i}/out/points/ \
		${i} \
		${DATA_DIR}/flink/random/n${i}/out/centers/
	cat  ${DATA_DIR}/flink/random/n${i}/out/points/* >>  ${DATA_DIR}/flink/random/n${i}/points
	cat  ${DATA_DIR}/flink/random/n${i}/out/centers/* >> ${DATA_DIR}/flink/random/n${i}/centers

	blos visualize plotpoints result \
	        ${DATA_DIR}/flink/random/n${i}/points  \
	        ${DATA_DIR}/flink/random/n${i}/kmeans-result-n${i}-init-random.eps:${DPI} \
	        ${DATA_DIR}/flink/random/n${i}/centers
done


# use good centers
# generate results for standard kmeans for N iterations
ITERATIONS="0 1 2 3 10"

for i in $ITERATIONS; do
        echo "iteration $i"
        blos examples run eu.blos.java.ml.clustering.FlinkKMeans \
                ${DATA_DIR}/dataset/points \
                ${DATA_DIR}/dataset/init_good_centers \
                ${DATA_DIR}/flink/good/n${i}/out/points/ \
                ${i} \
                ${DATA_DIR}/flink/good/n${i}/out/centers/
        cat  ${DATA_DIR}/flink/good/n${i}/out/points/* >>  ${DATA_DIR}/flink/good/n${i}/points
        cat  ${DATA_DIR}/flink/good/n${i}/out/centers/* >> ${DATA_DIR}/flink/good/n${i}/centers

        blos visualize plotpoints result \
                ${DATA_DIR}/flink/good/n${i}/points  \
                ${DATA_DIR}/flink/good/n${i}/kmeans-result-n${i}-init-good.eps:${DPI} \
                ${DATA_DIR}/flink/good/n${i}/centers
done

