#!/bin/bash
# KMeans
# Experiement
#
# 3 centers
# input space per dimension: [-1...+1]
# resolution #.###

DATA_DIR=~/tmp/blos/experiments/kmeans/50k

# cleanup
rm -r ${DATA_DIR}
mkdir -p ${DATA_DIR}/dataset
mkdir -p ${DATA_DIR}/result
mkdir -p ${DATA_DIR}/flink

NUM_SAMPLES=50000
NUM_CENTROIDS=3
RESOLUTION=3
ITERATIONS=10
RANGE=1.0
STDDEV=0.09
DPI=100
SEED=3
FORMAT=png

# prepare dataset

blos examples run eu.blos.java.ml.clustering.KMeansDatasetGenerator \
        -points ${NUM_SAMPLES} \
        -k ${NUM_CENTROIDS} \
        -stddev ${STDDEV} \
        -range ${RANGE} \
        -resolution ${RESOLUTION} \
	-output ${DATA_DIR}/dataset


blos visualize kmeans-plotter -i ${DATA_DIR}/dataset/points -o ${DATA_DIR}/dataset/kmeans-dataset-grid5.$FORMAT --dpi=${DPI} -s dataset --grid --gres=-1:1:0.5 --hideaxis

blos visualize kmeans-plotter -i ${DATA_DIR}/dataset/points -o ${DATA_DIR}/dataset/kmeans-dataset-grid2.$FORMAT --dpi=${DPI} -s dataset --grid --gres=-1:1:0.2 --hideaxis

blos visualize kmeans-plotter -i ${DATA_DIR}/dataset/points -o ${DATA_DIR}/dataset/kmeans-dataset-grid1.$FORMAT --dpi=${DPI} -s dataset --grid --gres=-1:1:0.1 --hideaxis

# produce good init
blos experiments kmeans-manipulate-centers \
	${DATA_DIR}/dataset/real_centers \
	0.8 \
	$SEED >> ${DATA_DIR}/dataset/good_centers

# random init
# generated by kmeans

blos visualize plotpoints points \
	${DATA_DIR}/dataset/points  \
	${DATA_DIR}/dataset/kmeans-dataset.$FORMAT:${DPI}

#blos visualize plotpoints points \
#        ${DATA_DIR}/dataset/points  \
#        ${DATA_DIR}/dataset/kmeans-dataset-grid.eps:${DPI} \
#	grid

blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-init-random.$FORMAT:${DPI} \
        ${DATA_DIR}/dataset/random_centers

blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-init-good.$FORMAT:${DPI} \
        ${DATA_DIR}/dataset/good_centers

blos visualize plotpoints points \
        ${DATA_DIR}/dataset/points  \
        ${DATA_DIR}/dataset/kmeans-dataset-init-real.$FORMAT:${DPI} \
        ${DATA_DIR}/dataset/real_centers


# use random centers
# generate results for standard kmeans for N iterations
ITERATIONS="0 1 2 3 10"

for i in $ITERATIONS; do
	echo "iteration $i"
	# run flink kmeans
	blos examples run eu.blos.java.ml.clustering.FlinkKMeans \
		${DATA_DIR}/dataset/points \
		${DATA_DIR}/dataset/random_centers \
		${DATA_DIR}/flink/random/n${i}/out/points/ \
		${i} \
		${DATA_DIR}/flink/random/n${i}/out/centers/
	# merge results into single file
	cat  ${DATA_DIR}/flink/random/n${i}/out/points/* >>  ${DATA_DIR}/flink/random/n${i}/points
	cat  ${DATA_DIR}/flink/random/n${i}/out/centers/* >> ${DATA_DIR}/flink/random/n${i}/centers

	# plot result with datapoints
	blos visualize plotpoints result \
	        ${DATA_DIR}/flink/random/n${i}/points  \
	        ${DATA_DIR}/flink/random/n${i}/kmeans-result-n${i}-init-random.$FORMAT:${DPI} \
	        ${DATA_DIR}/flink/random/n${i}/centers
done


# use good centers
# generate results for standard kmeans for N iterations
ITERATIONS="0 1 2 3 10"

for i in $ITERATIONS; do
        echo "iteration $i"
        blos examples run eu.blos.java.ml.clustering.FlinkKMeans \
                ${DATA_DIR}/dataset/points \
                ${DATA_DIR}/dataset/good_centers \
                ${DATA_DIR}/flink/good/n${i}/out/points/ \
                ${i} \
                ${DATA_DIR}/flink/good/n${i}/out/centers/
        cat  ${DATA_DIR}/flink/good/n${i}/out/points/* >>  ${DATA_DIR}/flink/good/n${i}/points
        cat  ${DATA_DIR}/flink/good/n${i}/out/centers/* >> ${DATA_DIR}/flink/good/n${i}/centers

        blos visualize plotpoints result \
                ${DATA_DIR}/flink/good/n${i}/points  \
                ${DATA_DIR}/flink/good/n${i}/kmeans-result-n${i}-init-good.$FORMAT:${DPI} \
                ${DATA_DIR}/flink/good/n${i}/centers
done

