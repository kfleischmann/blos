#!/bin/bash

DATA_DIR=/tmp/blos/kmeans/exp1

# cleanup
rm -r ${DATA_DIR}

# prepare folders
mkdir -p ${DATA_DIR}/dataset
mkdir -p ${DATA_DIR}/sketch 
mkdir -p ${DATA_DIR}/flink

# generate sample dataset
NUM_SAMPLES=50000
NUM_CENTROIDS=50
STDDEV=0.3
RESOLUTION=5
RANGE=1.0


# generate data
# OUTPUT: points and its centers
blos examples run eu.blos.java.ml.clustering.KMeansDatasetGenerator \
	-points ${NUM_SAMPLES} \
	-k ${NUM_CENTROIDS} \
	-stddev ${STDDEV} \
	-range ${RANGE} \
	-output ${DATA_DIR}/dataset \
	-resolution ${RESOLUTION}

# visualize the dataset
# OUTPUT: dataset-plot.pdf
blos visualize plotpoints points ${DATA_DIR}/dataset/points ${DATA_DIR}/dataset/points

#find closest center for each point for visualization
cat ${DATA_DIR}/dataset/points | blos visualize apply-centroids ${DATA_DIR}/dataset/centers >> ${DATA_DIR}/dataset/result
blos visualize plotpoints result ${DATA_DIR}/dataset/result ${DATA_DIR}/dataset/result


# run kmeans from apache flink

# generate random sampled
blos examples run eu.blos.java.ml.clustering.KMeansDatasetGenerator \
	-output-centroids ${DATA_DIR}/flink \
	-k ${NUM_CENTROIDS} \
	 -range ${RANGE} \
        -resolution ${RESOLUTION}
	

blos examples run org.apache.flink.examples.java.clustering.KMeans \
	${DATA_DIR}/dataset/points \
	${DATA_DIR}/flink/centers \
	${DATA_DIR}/flink/out/ \
	100

cat ${DATA_DIR}/flink/out/* >> ${DATA_DIR}/flink/result
blos visualize plotpoints result ${DATA_DIR}/flink/result ${DATA_DIR}/flink/result


# run skeched kmeans
blos examples run eu.blos.java.ml.clustering.SketchedKMeans \
	-i ${DATA_DIR}/dataset/points \
	-o ${DATA_DIR}/sketch \
	-k ${NUM_CENTROIDS} \
	-n 100 \
	-p 5  \
	-s 0.01:0.01 \
	-H 100 \
	-print-sketch
# plot results
cat ${DATA_DIR}/dataset/points | blos visualize apply-centroids ${DATA_DIR}/sketch/centers >> ${DATA_DIR}/sketch/result
blos visualize plotpoints result ${DATA_DIR}/sketch/result ${DATA_DIR}/sketch/result


